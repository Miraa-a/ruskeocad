<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>RusCad</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico">
  <link rel="stylesheet" href="TemplateData/style.css">
  <style>
      .unity-preloader-video {
          position: absolute;
          left: 0;
          top: 0;
          transition: opacity 0.5s;
          object-fit: cover;
          background-color: white;
      }

      .unity-preloader-video-blocker {
          position: absolute;
          left: 0;
          top: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0, 0, 0, 0);
      }
      
      .modal-blocker {
          position: absolute;
          z-index: 10000;
          left: 0;
          top: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(0,0,0,0.5);
      }
      
      #rtf-editor-root {
          position: absolute;
          z-index: 10001;
          left: 25%;
          top: 25%;

          flex-direction: column;
      }
  </style>
  <link rel="stylesheet" href="richtexteditor/style.css" />
</head>
<body>
<div id="unity-container" class="unity-desktop">
  <canvas id="unity-canvas" width=1 height=1></canvas>
  <div id="unity-loading-bar">
    <div id="unity-logo"></div>
    <div id="unity-progress-bar-empty">
      <div id="unity-progress-bar-full"></div>
    </div>
  </div>
  <div id="unity-footer">
    <div id="unity-webgl-logo"></div>
    <div id="unity-fullscreen-button"></div>
    <div id="unity-build-title">RusCad</div>
  </div>
  <div style="display:none;">
    <br/><br/><br/>
    <textarea id="logg"></textarea>
  </div>
  <video width=1 height=1 class="unity-preloader-video" src="media/logo.mp4"></video>
  <div class="unity-preloader-video-blocker"></div>
</div>

<div style="display: none">
  <canvas id="rtf-canvas"></canvas>
</div>
<div class="modal-blocker" style="display: none"></div>
<div style="display:none;" id="rtf-editor-root">
  <link rel="stylesheet" href="richtexteditor/rte_theme_default.css"/>
  <script type="text/javascript" src="richtexteditor/rte.js"></script>
  <script>RTE_DefaultConfig.url_base = 'richtexteditor'</script>
  <script type="text/javascript" src='richtexteditor/plugins/all_plugins.js'></script>
  <div id="div_editor1">
    <p>Текст</p>
  </div>

  <div style="padding: 10px 0">
      <button 
        style="font-size: 20px;"
        type="button"
        onclick="_acceptRte()"
      >Применить</button>
      <button
        style="font-size: 20px;"
        type="button"
        onclick="_closeRte()"
      >Отмена</button>
  </div>
</div>

<script>
  const _width = 960;
  const _height = 600;
  let origWarn = console.warn;
  let textarea = document.querySelector('textarea#logg');
  let videoPreloader = document.querySelector('.unity-preloader-video');
  let unityCanvas = document.querySelector('#unity-canvas');
  if (textarea) {
    Object.defineProperty(console, 'warn', {
      value: (...args) => {
        textarea.value += '\n' + args[0];
        return origWarn.call(origWarn, ...args);
      },
    });
  }

  videoPreloader
    .addEventListener('ended', (ev) => {
      videoPreloader.style.opacity = '0';
      setTimeout(() => {
        videoPreloader.style.display = 'none';
        document.querySelector('.unity-preloader-video-blocker').style.display = 'none';
      }, 1000);
    });
  videoPreloader.muted = true;
  videoPreloader.play();
  videoPreloader.addEventListener('canplay', () => {
    if (videoPreloader.paused) videoPreloader.play();
  });

  videoPreloader.width = _width;
  videoPreloader.height = _height;
  unityCanvas.width = _width;
  unityCanvas.height = _height;

  var buildUrl = 'Build';
  var loaderUrl = buildUrl + '/Build.loader.js';
  var __timeKey = parseInt(new Date().getTime() / 3600000);
  var config = {
    dataUrl: buildUrl + '/Build.data',
    frameworkUrl: buildUrl + '/Build.framework.js',
    codeUrl: buildUrl + '/Build.wasm',
    streamingAssetsUrl: 'StreamingAssets',
    companyName: 'Ruskeo',
    productName: 'RusCad',
    productVersion: '0.1',
    productVersion: '0.1',
  };

  var container = document.querySelector('#unity-container');
  var canvas = document.querySelector('#unity-canvas');
  var loadingBar = document.querySelector('#unity-loading-bar');
  var progressBarFull = document.querySelector('#unity-progress-bar-full');
  var fullscreenButton = document.querySelector('#unity-fullscreen-button');
  var mobileWarning = document.querySelector('#unity-mobile-warning');

  // By default Unity keeps WebGL canvas render target size matched with
  // the DOM size of the canvas element (scaled by window.devicePixelRatio)
  // Set this to false if you want to decouple this synchronization from
  // happening inside the engine, and you would instead like to size up
  // the canvas DOM size and WebGL render target sizes yourself.
  // config.matchWebGLToCanvasSize = false;

  if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
    container.className = 'unity-mobile';
    // Avoid draining fillrate performance on mobile devices,
    // and default/override low DPI mode on mobile browsers.
    config.devicePixelRatio = 1;
    mobileWarning.style.display = 'block';
    setTimeout(() => {
      mobileWarning.style.display = 'none';
    }, 5000);
  } else {
    canvas.style.width = '960px';
    canvas.style.height = '600px';
  }
  loadingBar.style.display = 'block';

  var script = document.createElement('script');
  script.src = loaderUrl;
  script.onload = () => {
    createUnityInstance(canvas, config, (progress) => {
      progressBarFull.style.width = 100 * progress + '%';
    }).then((unityInstance) => {
      loadingBar.style.display = 'none';
      fullscreenButton.onclick = () => {
        unityInstance.SetFullscreen(1);
      };
      window._unityInstance = unityInstance;
    }).catch((message) => {
      alert(message);
    });
  };
  document.body.appendChild(script);
</script>

<script src="richtexteditor/iframe2image.withdomvas.min.js"></script>
<script>
  // RTF EDITOR
  var rteEditor = new RichTextEditor('#div_editor1', {});
  var rteConfig = {};
  window._Rte_Editor = rteEditor;
  window._Rte_Config = rteConfig;
  function _setRteActive(active){
    if (active) {
      document
        .querySelectorAll(".modal-blocker, rte-floatpanel")
        .forEach(i => i.style.display = "inherit");
      document.querySelector('#rtf-editor-root').style.display = 'flex';
    } else {
      document
        .querySelectorAll(".modal-blocker, #rtf-editor-root, rte-floatpanel")
        .forEach(i => i.style.display = "none");
    }
  }
  
  window._onRichTextOpen = (gameObjectName, methodName, rawHtmlVal, w, h) => {
    console.log('Received rtf open', [gameObjectName, methodName, rawHtmlVal, w, h]);
    _setRteActive(true);
    rteEditor.setHTMLCode("<p>Текст</p>");
    rteConfig = {
      gameObjectName,
      methodName,
      rawHtmlVal,
      w,
      h,
      unityInstance: window._unityInstance,
    };
    window._Rte_Config = rteConfig;
  };
  
  window._closeRte = () => {
    _setRteActive(false);
  };
  
  window._acceptRte = () => {
    var editorEl = document.querySelector(".rte-editable");
    var canvas = document.querySelector("#rtf-canvas"), 
      context = canvas.getContext('2d');
    
    iframe2image(editorEl, function (err, img) {
      if (err) {
        _setRteActive(false);
        return console.error(err); 
      }

      canvas.width = editorEl.clientWidth;
      canvas.height = editorEl.clientHeight;
      context.drawImage(img, 0, 0);
      var resImg = canvas.toDataURL('image/png');
      window._unityInstance
        .SendMessage(
          rteConfig.gameObjectName,
          rteConfig.methodName,
          resImg.split(';base64,')[1] || resImg
        );
      _setRteActive(false);
    });
  }
</script>
<script src="richtexteditor/patch.js"></script>
</body>
</html>